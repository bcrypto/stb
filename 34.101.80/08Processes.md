# 8 <a name="Processes"></a>Процессы

## 8.1 <a name="Processes1"></a>Выработка подписи

### 8.1.1 <a name="Processes11"></a>Соглашения

Подпись вырабатывается с помощью средства ЭЦП, аппаратного или программного.
Средство ДОЛЖНО соответствовать требованиям СТБ 34.101.27. В пределах
криптографической границы средства ДОЛЖЕН храниться личный ключ вместе с
соответствующим СОК или однозначной ссылкой на него. Средство ДОЛЖНО
реализовывать сервис выработки подписи. ДОЛЖНА быть предусмотрена возможность
аутентификации подписанта для доступа к сервису.

Со средством ЭЦП взаимодействует программа выработки подписи. Программа передает
средству документ, который требуется подписать, организует взаимодействие между
средством и подписантом. В совокупности средство ЭЦП и программа выработки
подписи составляют СВП.

С СВП, в свою очередь, взаимодействует прикладная программа. Именно здесь
готовится подписываемый документ, формируются атрибуты, аттестаты и прочие
данные, необходимые для выработки РЭЦП. Подготовленные данные передаются
системе. Перечень передаваемых данных определяется политикой выработки подписи.
Политика описывается специальным документом, задается конфигурационными файлами
прикладной программы или жестко фиксируется в ее коде. Политика определяет
формат подписи (CAdES, XAdES или PAdES), задает профиль, определяет размещение
подписи (вложенная, обертывающая или отделенная). Прикладная программа МОЖЕТ
указать СВП подписывать только определенные части документа.

Подписываемый документ МОЖЕТ передаваться СВП напрямую или косвенно — через
хэш-значение. Если документ передается напрямую, то хэш-значение формируется в
самой системе. Перед выработкой хэш-значения документ МОЖЕТ предварительно
подготавливаться (канонизироваться, нормализироваться).

Выработка РЭЦП профилей B-T, B-LT, B-LTA состоит в дополнении РЭЦП предыдущего
профиля. Дополнение МОЖЕТ выполнять не только подписант с помощью СВП, но и
верификатор или любая другая заинтересованная сторона. Для этого вместо СВП
может использоваться специальная программа дополнения подписи.

### 8.1.2 <a name="Processes12"></a>Выработка подписи профиля B-B

При выработке РЭЦП профиля B-B входными данными являются:

- подписываемый документ или его хэш-значение;
- СОК подписанта;
- другие атрибуты.

Сертификат и атрибуты передаются прикладной программой, загружаются из
конфигурационных файлов СВП или задаются подписантом. СОК МОЖЕТ загружаться из
средства ЭЦП.

Прикладная программа ДОЛЖНА отобразить документ, который подписывается.
Подписант ДОЛЖЕН иметь возможность просмотреть отображаемый документ и
подписываемые атрибуты. Отображаемый документ (внешнее представление) ДОЛЖЕН
соответствовать подписываемому (внутреннее представление). Отображение документа
МОЖЕТ быть организовано в СВП.

Если подписывается уже подписанный документ, то подписанту ДОЛЖНА быть
предоставлена возможность проверки всех предыдущих подписей. Для этого ДОЛЖНА
использоваться программа проверки подписи, описанная в [8.2](#Processes2). Если
программа возвращает вердикт `FAILED` или `INDETERMINATE`, то подписанту ДОЛЖНО
быть выдано предупреждение.

Если политика подписи требует получения согласия на подпись, то оно ДОЛЖНО быть
получено от подписанта прикладной программой или СВП.

После получения входных данных СВП формирует подписываемые атрибуты (в том числе
хэш-значение документа), форматирует их, хэширует. После этого средство ЭЦП
вырабатывает базовую подпись полученного хэш-значения. Подпись вырабатывается на
личном ключе подписанта. Перед выработкой подписи СВП следует проверить
действительность СОК подписанта. После того, как базовая подпись выработана,
программе выработки подписи СЛЕДУЕТ ее проверить на открытом ключе
соответствующего сертификата.

Перед выработкой базовой ЭЦП МОЖЕТ выполняться аутентификация подписанта перед
средством. Аутентификация МОЖЕТ быть организована прикладной программой,
программой выработки подписи или выполнена напрямую.

<!--
Может использоваться несколько факторов аутентификации. 

Странная фраза:

A signer authentication mechanism may be of a form that prevents impersonation 
attacks even from the DA or the SCA and their environment.

DA / SCA не могут выдать себя за средство? за подписанта?
-->

После выработки базовой ЭЦП формируется расширенная. СВП возвращает РЭЦП
прикладной программе, либо сообщает об ошибке.

### 8.1.3 <a name="Processes13"></a>Выработка подписи профиля B-T

Выработка РЭЦП профиля B-T состоит в дополнении РЭЦП профиля B-B. Входными
данными при этом являются:

- РЭЦП профиля B-B;
- политика дополнения подписи (опционально).

Сначала выполняется запрос к службе штампов времени. В качестве запроса
выступает базовая ЭЦП. Полученный от службы штамп добавляется к РЭЦП как
неподписанный атрибут. МОЖЕТ использоваться несколько служб и, соответственно,
штампов. Перечень служб задается входной политикой или определяется другим
образом.

Штамп времени является доказательством того, что базовая ЭЦП была выработана к
определенному моменту времени. Другой формой доказательства является рапорт
времени, который фиксируется службой рапортов времени и не добавляется в
подпись. Управление рапортами в настоящем стандарте не рассматривается.

Штамп времени подписи создает основу для долгосрочного действия РЭЦП. Штамп
СЛЕДУЕТ получить до истечения срока действия СОК подписанта, и тогда РЭЦП может
быть проверена даже по окончании действия СОК. РЕКОМЕНДУЕТСЯ получать штамп
сразу после выработки базовой ЭЦП.

Если верификатор или другая заинтересованная сторона не доверяет службе,
выдавшей штамп, то они МОГУТ получить альтернативный штамп у другой службы и
добавить штамп в РЭЦП.

Перед обращением к службе штампов времени входная РЭЦП профиля B-B МОЖЕТ
предварительно проверяться. При отрицательном результате проверки процесс
дополнения подписи ДОЛЖЕН быть прекращен.

### 8.1.4 <a name="Processes14"></a>Выработка подписи профиля B-LT

Выработка РЭЦП профиля B-LT состоит в дополнении РЭЦП профиля B-T. Входными
данными при этом являются:

- РЭЦП профиля B-T;
- политика дополнения подписи (опционально).

Сначала проверяется входная подпись. Если проверка дала отрицательный результат,
то дополнение подписи прекращается. В противном случае в РЭЦП добавляются
аттестаты, заданные входной политикой или определенные другим способом.
Аттестаты оформляются как неподписанные атрибуты.

Включение аттестатов в РЭЦП делает ее автономной и позволяет организовать
проверку даже при отсутствии онлайн-доступа к задействованным поставщикам услуг
доверия.

### 8.1.5 <a name="Processes15"></a>Выработка подписи профиля B-LTA

Выработка РЭЦП профиля B-LTA состоит в дополнении РЭЦП профиля B-LT или B-LTA.
Входными данными при этом являются:

- РЭЦП профиля B-LT или B-LTA;
- политика дополнения подписи (опционально).

Сначала проверяется входная подпись. Если проверка дала отрицательный результат,
то дополнение подписи прекращается. В противном случае в РЭЦП добавляются все
аттестаты, которые подтверждают состоятельность подписи на данный момент
времени. ДОЛЖНЫ быть добавлены аттестаты, которые касаются предыдущих штампов
времени. Аттестаты добавляются как неподписанные атрибуты.

После добавления аттестатов выполняется запрос к службе штампов времени. Запрос
ДОЛЖЕН покрывать базовую ЭЦП и все неподписанные атрибуты. Полученный от службы
штамп добавляется к РЭЦП как неподписанный атрибут. Может использоваться
несколько служб и, соответственно, штампов. Перечень служб задается входной
политикой или определяется другим образом.

<!--
Не очень понятно про дополнительные аттестаты:

Request one or more time-assertions from appropriate TSAs as defined in the 
signature policy or local configuration. The time-assertion shall cover the 
signer's document as well as all data objects contained in the signature
-->

## 8.2 <a name="Processes2"></a>Проверка подписи

### 8.2.1 <a name="Processes21"></a>Cоглашения

Для проверки подписи прикладная программа обращается к ППП. ППП получает
подпись, которую требуется проверить, и, в случае отделенной или вложенной
подписи, соответствующий документ или его хэш-значение. Дополнительными входными
данными являются допустимые политики проверки подписи, время проверки,
аттестаты. ППП может получать аттестаты не от прикладной программы, а напрямую
от поставщиков услуг доверия. ППП возвращает вердикт проверки и отчет, который
описывает детали проверки и объясняет вердикт.

Политика проверки подписи определяет политику применения сертификатов,
криптографические ограничения (наборы допустимых криптографических алгоритмов,
их долговременных параметров, длин их ключей), другие аспекты проверки. Политики
описываются специальными документами, задаются конфигурационными файлами
прикладной программы или жестко фиксируются в ее коде. Нужная политика
определяется во время проверки РЭЦП.

Прикладная программа может дополнительно указать профиль подписи, в соответствии
с которым следует организовать проверку. Например, профиль B-B может быть
выбран, если в момент проверки срок действия СОК подписанта не истек (или истек
недавно) и сертификат не был отозван. Если профиль не задан, то ППП выбирает его
сама. ДОЛЖЕН быть выбран максимальный из поддерживаемых профилей, подходящих к
проверяемой РЭЦП.

<!--
the time of validation lies beyond the validity period of the signing 
certificate when the certification authority provides revocation 
information for expired certificates. 

NOTE: Validation of signatures where involved certificates are expired at 
validation time, but not revoked, depends on the signature validation 
policy in use. A policy can e.g. well allow using the Validation Process 
for Basic Signatures for validating a signature that has been created two 
days ago, and the involved certificate expired yesterday.
-->

ППП проводит проверки, определяемые профилем подписи и уточняемые ее политикой.
Окончательный вердикт принимает одно из трех значений:

- `PASSED` (действительная подпись): все проверки прошли успешно и все
  ограничения политики выполнены;
- `FAILED` (недействительная подпись): одна из проверок завершена с ошибкой
  или одно из ограничений политики не выполнено или установлено, что
  подпись выработана после отзыва СОК подписанта;
- `INDETERMINATE` (незавершенная проверка): полученные в ходе проверки
  результаты не позволяют сделать однозначный вывод в пользу `PASSED` или
  `FAILED`.

Вердикт `INDETERMINATE` может быть изменен (как в пользу `PASSED`, так и в
пользу `FAILED`), если ППП будут переданы дополнительные аттестаты (например,
обновленный СОC).

Вердикт `FAILED` уточняется следующими статусами (дополнительными пояснениями):

- `FORMAT_FAILURE` — ошибка формата;
- `HASH_FAILURE` — некорректное хэш-значение;
- `SIG_CRYPTO_FAILURE` — некорректная базовая ЭЦП;
- `REVOKED` — сертификат подписанта отозван к моменту проверки подписи 
  (что подтверждено аттестатом отзыва). 

Вердикт `INDETERMINATE` уточняется следующими статусами: 

- `SIG_CONSTRAINTS_FAILURE` — один из атрибутов РЭЦП не удовлетворяет 
  политике проверки; 
- `CHAIN_CONSTRAINTS_FAILURE` — цепочка сертификатов не удовлетворяет 
  политике применения сертификатов; 
- `CERTIFICATE_CHAIN_GENERAL_FAILURE` — общая ошибка при проверке цепочки 
  сертификатов;
- `CRYPTO_CONSTRAINTS_FAILURE` — нарушены криптографические ограничения, 
  например, криптографические алгоритмы перестали быть надежными;
- `EXPIRED` — подпись выработана после окончания срока 
  действия сертификата подписанта (что подтверждено штампом времени); 
- `NOT_YET_VALID` — подпись выработана до начала срока действия 
  сертификата подписанта (что подтверждено штампом времени);
- `POLICY_PROCESSING_ERROR` — ошибка при обработке политики проверки 
  подписи; 
- `SIGNATURE_POLICY_NOT_AVAILABLE` — недоступна политика проверки 
  подписи;
- `TIMESTAMP_ORDER_FAILURE` — нарушены соглашения об очередности штампов 
  времени; 
- `NO_SIGNING_CERTIFICATE_FOUND` — не найден сертификат подписанта; 
- `NO_CERTIFICATE_CHAIN_FOUND` — не найдена цепочка сертификатов; 
- `REVOKED_NO_POE` — сертификат подписанта отозван, но возможно он 
  действовал в момент выработки подписи; 
- `REVOKED_CA_NO_POE` — сертификат УЦ отозван, но возможно он действовал в 
  момент выработки подписи; 
- `OUT_OF_BOUNDS_NO_POE` — сертификат подписанта прекратил действие, но 
  возможно он действовал в момент выработки подписи;
- `CRYPTO_CONSTRAINTS_FAILURE_NO_POE` — криптографические ограничения не 
  выполнены, но возможно они выполнялись в момент выработки подписи;
- `NO_POE` — отсутствует доказательство существования;
- `TRY_LATER` — выполнены не все условия, но возможно они будут выполнены 
  в будущем;
- `SIGNED_DATA_NOT_FOUND` — не найден подписанный документ;
- `GENERIC` — другое.

Вердикт `PASSED` может представляться статусом `OK`.

Отчет о проверке, который готовит ППП, ДОЛЖЕН содержать следующую информацию:

- вердикт:  `PASSED`, `FAILED` или `INDETERMINATE`;
- использованную политику проверки;
- время проверки;
- использованный профиль.

Отчет МОЖЕТ включать другие данные, например: 

- электронный документ, подпись которого проверена;
- информацию о подписанте;
- атрибуты подписи;
- статус в случае вынесения вердиктов `FAILED` и `INDETERMINATE`;
- при вынесении вердикта `FAILED` причины, по которым подпись 
  признана недействительной;
- при вынесении промежуточного вердикта `INDETERMINATE` шаги, которые
  должны быть выполнены, чтобы определить окончательный вердикт.

### 8.2.2 <a name="Processes22"></a>Вспомогательные алгоритмы

#### 8.2.2.1 <a name="Processes221"></a>Проверка актуальности аттестата отзыва

Алгоритм проверки актуальности аттестата отзыва получает на вход: 

- аттестат отзыва;
- время проверки;
- политику применения сертификатов.

Алгоритм проверяет, является ли аттестат актуальным в заданный момент времени.
Алгоритм возвращает `PASSED`, если аттестат признан актуальным, и `FAILED` в
противном случае.

**Шаг 1**. По политике применения сертификатов определить интервал обновления
аттестата отзыва входного типа. Если интервал не определен в политике явно, но
аттестат представляет собой СОС или OCSP-ответ, и в этих объектах задано поле
`nextUpdate`, то искомый интервал определить как разницу между `nextUpdate` и
`thisUpdate`. Если интервал определить не удалось, то возвратить `FAILED`.

**Шаг 2**. Если разность между временем проверки и временем выпуска аттестата
больше интервала, определенного на шаге 1, то возвратить `FAILED`. Иначе —
возвратить `PASSED`.

#### 8.2.2.2 <a name="Processes222"></a>Проверка сертификата

Алгоритм проверки сертификата получает на вход:

- проверяемый СОК;
- время проверки;
- список точек доверия;
- аттестаты;
- политику применения сертификатов.

Алгоритм проверяет, является ли СОК корректным в заданный момент времени.
Доказательством корректности СОК является корректная цепочка сертификатов,
связывающая этот СОК с некоторой точкой доверия. Алгоритм возвращает максимально
подходящую цепочку и статус ее сертификатов в момент проверки.

**Шаг 1.** По аттестатам построить новую цепочку сертификатов, которая
начинается в некоторой точке доверия и заканчивается проверяемым СОК.

Если новую цепочку построить не удалось, то возвратить последнюю построенную
цепочку и ее статус.

Если ни одной цепочки не построено, то возвратить пустую цепочку и статус
`NO_CERTIFICATE_CHAIN_FOUND`.

**Шаг 2.** Верифицировать построенную цепочку с помощью алгоритма, определенного
в СТБ 34.101.19 (подраздел 8.1). На вход алгоритма подать заданное время
проверки.

При верификации проверяется, что эмитент следующего сертификата является
субъектом предыдущего. Базовая ЭЦП следующего сертификата проверяется на
открытом ключе предыдущего. Кроме этого, проверяется, что все сертификаты
цепочки действительны в заданный момент времени.

Для проверки действительности сертификатов искать среди входных аттестатов
подходящие аттестаты отзыва. Если имеется несколько подходящих аттестатов
относительно некоторого сертификата, то использовать самый последний аттестат.

**Шаг 3.** Обработать результат верификации следующим образом:

а) если верификация завершена успешно, то проверить актуальность выбранных
аттестатов отзыва. Использовать для этого алгоритм [8.2.2.1](#Processes221).
Если алгоритм выносит вердикт `FAILED` хотя бы для одного аттестата, то
возвратить цепочку и статус `TRY_LATER`.

б) если верификация завершена с ошибкой из-за того, что промежуточный сертификат
(сертификат УЦ) был отозван к моменту проверки, то зафиксировать цепочку со
статусом `REVOKED_CA_NO_POE` и вернуться к шагу 1.

в) если верификация завершена с ошибкой из-за того, что последний (проверяемый)
сертификат был отозван к моменту проверки, то возвратить цепочку со статусом
`REVOKED_NO_POE`.

г) если верификация завершена с ошибкой из-за того, что последний сертификат был
приостановлен в момент проверки, то возвратить цепочку со статусом `TRY_LATER`.

д) если верификация завершена с ошибкой из-за того, что последний сертификат не
действовал в момент проверки, то возвратить цепочку со статусом
`OUT_OF_BOUNDS_NO_POE`.

При других ошибках верификации зафиксировать цепочку со статусом
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1.

<!--
todo: разобраться, в СТБ 34.101.19 только первая модель

>Примечание — Могут использоваться две модели верификации:
- все сертификаты цепочки, кроме последнего, 
  действительны в указанное время проверки;
- каждый из сертификатов, кроме последнего, 
  был действителен в момент, когда он использовался для выпуска 
  следующего сертификата. 
>Модель определяется политикой проверки.
-->

**Шаг 4.** Для каждого сертификата цепочки проверить выполнение ограничений
политики применения сертификатов. Если ограничения не выполнены, то
зафиксировать цепочку со статусом `CHAIN_CONSTRAINTS_FAILURE` и вернуться к 
шагу 1.

**Шаг 5.** Для каждого сертификата цепочки проверить выполнение 
криптографических ограничений. Если ограничения не выполнены, то
зафиксировать цепочку со статусом `CRYPTO_CONSTRAINTS_FAILURE_NO_POE` и 
вернуться к шагу 1.

**Шаг 6.** Возвратить цепочку со статусом `OK`.

#### 8.2.2.3 <a name="Processes223"></a>Проверка штампа времени

Алгоритм проверки штампа времени получает на вход:

- штамп времени;
- хэш-значение данных, для которых выпущен штамп;
- список политик проверки подписи (опционально);
- сертификат службы штампов времени (опционально);
- список точек доверия (опционально).

Алгоритм проверяет корректность штампа времени как электронного документа
формата CAdES. Содержимое документа описывается типом `TSTInfo`, определенным в
СТБ 34.101.82. Компонент `messageImprint` этого типа описывает хэш-значение
данных, для которых выпущен штамп, компонент `genTime ` — время выпуска.
Алгоритм возвращает вердикт проверки. Успешный вердикт сопровождается
извлеченным из штампа временем выпуска, неуспешный — статусом.

**Шаг 1.** Проверить подпись штампа как РЭЦП профиля B-B. Использовать алгоритм
[8.2.3](#Processes23). Переадресовать алгоритму собственные входные данные, в
том числе сертификат службы штампов времени в качестве сертификата подписанта.

**Шаг 2.** Если алгоритм [8.2.3](#Processes23) завершен с вердиктом `FAILED` или
`INDETERMINATE`, то возвратить этот вердикт вместе с соответствующим статусом.

**Шаг 3.** Проверить, что вложенная в штамп структура типа `TSTInfo`
соответствует ограничениям СТБ 34.101.82. Если ограничения нарушены, то
возвратить `FAILED` со статусом `FORMAT_FAILURE`.

**Шаг 4.** Извлечь из `TSTInfo` хэш-значение данных, для которых выпущен штамп,
и время выпуска. Сравнить извлеченное хэш-значение с входным. В случае
несовпадения возвратить `FAILED` со статусом `HASH_FAILURE`.

**Шаг 5.** Возвратить вердикт `PASSED` и время выпуска.

#### 8.2.2.4 <a name="Processes224"></a>Сдвиг времени проверки

Алгоритм сдвига времени проверки получает на вход:

- цепочку сертификатов;
- список доказательств существования;
- аттестаты;
- политику применения сертификатов;
- криптографические ограничения.

Алгоритм определяет самый поздний момент времени, в который последний сертификат
входной цепочки будет признан действительным, в том числе тот, в который цепочка
будет успешно верифицирована. Искомый момент определяется многократными сдвигами
в прошлое текущего момента. Сдвиг выполняется при обработке отзывов сертификатов
цепочки, при нарушении криптографических ограничений, и при потере актуальности
аттестатов отзыва. Алгоритм возвращает `OK` и искомый момент времени. Если
момент определить не удалось, то алгоритм возвращает `NO_POE`.

**Шаг 1.** Инициализировать переменную `control-time` текущим моментом времени.

**Шаг 2.** Для каждого сертификата цепочки, начиная с первого (выданного точкой
доверия), выполнить следующие действия.

а) найти корректные аттестаты отзыва, касающиеся текущего сертификата, которые
выпущены ранее `control-time` и для которых имеется доказательство существования
к моменту `control-time`. Возвратить `NO_POE`, если не найдено ни одного
подходящего аттестата.

<!--
todo: в оригинале требуется док-во (одно?) и аттестата, и сертификата.
Но ведь если существует аттестат на сертификат, то существует и аттестат.
-->

б) обработать каждый из найденных аттестатов: 

- если аттестат определяет отзыв сертификата, то изменить `control-time` 
  на время отзыва;
- если аттестат не определяет отзыв сертификата, то проверить актуальность
  аттестата с помощью алгоритма [8.2.2.1](#Processes221) на момент 
  `control-time`. Если алгоритм возвращает `FAILED`, то изменить 
  `control-time` на время выпуска аттестата;
- проверить, что сертификат и аттестат удовлетворяют криптографическим 
  ограничениям на момент `control-time`. Если ограничения не выполняются, то 
  изменить `control-time` на самое позднее время, когда они еще выполнялись. 

<!--
todo: control-time обновляется итерационно. Могут появиться противоречия.
Например, время отзыва м.б. позже `control-time`.
-->

**Шаг 3.** Возвратить `OK` и `control-time`.

#### 8.2.2.5 <a name="Processes225"></a>Проверка сертификата в прошлом

Алгоритм проверки сертификата в прошлом получает на вход:

- РЭЦП (возможно штамп времени);
- проверяемый сертификат;
- список точек доверия;
- список доказательств существования;
- аттестаты;
- политику применения сертификатов;
- криптографические ограничения.

Алгоритм проверяет, являлся ли СОК корректным в некоторый момент времени в
прошлом. Доказательством корректности СОК является корректная цепочка
сертификатов, связывающая этот СОК с некоторой точкой доверия. Если цепочку
найти удалось, то она возвращается со статусом `OK` и максимально поздним
моментом времени, в который она еще была корректна. Если подходящую цепочку
найти не удалось, то возвращаются максимально подходящая цепочка и ее статус.

<!--
todo: нужно ли возвращать цепочку?
-->

<!--
todo: переработать или убрать

Суть алгоритма состоит в следующем. Цепочка является корректной, если 
для каждого ее сертификата либо имеется аттестат отзыва о корректности в настоящем,
либо имеется устаревший аттестат, который подтверждает существование сертификата
в момент в прошлом, когда эмитент сертификата был надежен. 
-->

**Шаг 1.** По аттестатам построить новую цепочку сертификатов, которая
начинается в некоторой точке доверия и заканчивается проверяемым СОК.

Если новую цепочку построить не удалось, то возвратить последнюю построенную
цепочку и ее статус.

Если ни одной цепочки не построено, то возвратить пустую цепочку и статус
`NO_CERTIFICATE_CHAIN_FOUND`.

**Шаг 2.** Верифицировать построенную цепочку с помощью алгоритма, определенного
в СТБ 34.101.19 (подраздел 8.1). На вход алгоритма подать любую отметку времени
из области пересечения сроков действия сертификатов цепочки. Если область
пересечения пуста, то зафиксировать цепочку со статусом
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1.

При верификации проверяется, что эмитент следующего сертификата является
субъектом предыдущего. Базовая ЭЦП следующего сертификата проверяется на
открытом ключе предыдущего. Действительность сертификатов в выбранный момент
времени не проверять.

При ошибках верификации зафиксировать цепочку со статусом 
`CERTIFICATE_CHAIN_GENERAL_FAILURE` и вернуться к шагу 1. 

**Шаг 3.** Применить алгоритм [8.2.2.4](#Processes224). Если алгоритм возвращает
статус, отличный от `OK`, то назначить этот статус цепочке и вернуться к шагу 1.
Если алгоритм возвращает статус `OK`, то зафиксировать дополнительный возврат —
самый поздний момент времени, когда все сертификаты цепочки признаются
действительными.

**Шаг 4.** Проверить, что цепочка удовлетворяет ограничениям политики применения
сертификатов. Если ограничения нарушены, то зафиксировать цепочку со статусом
`CHAIN_CONSTRAINTS_FAILURE` и вернуться к шагу 1.

**Шаг 5.** Возвратить цепочку со статусом `OK` и моментом времени,
зафиксированным на шаге 3.

#### 8.2.2.6 <a name="Processes226"></a>Извлечение доказательств существования

Алгоритм извлечения доказательств существования получает на вход: 

- РЭЦП;
- штамп времени;
- список доказательств существования (возможно пустой).

Алгоритм, используя штамп времени, строит список доказательств существования 
объектов, входящих в РЭЦП. Список может быть пустым.

**Шаг 1.** Построить множество *S* объектов или ссылок на объекты, которые
входят в РЭЦП и контролируются штампом времени. Зафиксировать время *T* выпуска
штампа.

**Шаг 2.** Если некоторые объекты *S* содержат вложенные объекты, которые могут
использоваться при проверке подписи, то добавить эти объекты в *S*.

**Шаг 3.** Инициализировать пустой список *P* доказательств существования.

**Шаг 4.** Проанализировать ссылки на объекты, входящие в *S*. Если ссылка
на объект *O* представляет собой хэш-значение *h(O)* и функция хэширования
*h* удовлетворяла криптографическим ограничениям вплоть до момента *T*, то:

- добавить в *P* ссылку *h(O)*;
- если входной список доказательств существования содержит 
  доказательство для объекта *O* на момент времени после *T*, 
  то добавить в *P* доказательство существования *O* на момент *T*.

**Шаг 5.** Для каждого объекта *O* из *S* добавить в *P* доказательство 
существования *O* в момент *T*. 

**Шаг 6.** Возвратить *P*. 

#### 8.2.2.7 <a name="Processes227"></a>Повторная проверка подписи

Алгоритм повторной проверки подписи получает на вход:

- РЭЦП;
- вердикт/статус предыдущей проверки;
- СОК подписанта;
- список точек доверия;
- список доказательств существования;
- аттестаты (опционально);
- политику применения сертификатов (опционально);
- криптографические ограничения (опционально). 

Алгоритм применяется после завершенной проверки, которая вынесла неопределенный
вердикт `INDETERMINATE`. Дополнительные доказательства существования могут
изменить вердикт, сделав его определенным. Алгоритм либо повторяет предыдущие
вердикт и статус, либо меняет его на `PASSED`, `FAILED` или `INDETERMINATE` со
статусом `NOT_YET_VALID`.

**Шаг 1.** Выполнить алгоритм [8.2.2.5](#Processes225), переадресовав ему
необходимые входные данные. Если алгоритм возвращает статус `OK`, то
зафиксировать дополнительно возвращаемое время. В противном случае возвратить
входные вердикт и статус.

**Шаг 2.** Если имеется доказательство существования базовой подписи к моменту
времени, зафиксированному на шаге 1, то разобрать входной статус следующим
образом:

а) при статусе `REVOKED_NO_POE` возвратить вердикт `PASSED`;

б) при статусе `REVOKED_CA_NO_POE` искать доказательство существования аттестата
отзыва сертификата УЦ, приведшего к назначению вердикта. Если доказано
существование на момент времени, не позже зафиксированного на шаге 2, то
возвратить `PASSED`. Иначе — возвратить `INDETERMINATE` и статус
`REVOKED_CA_NO_POE`;

в) при статусе `OUT_OF_BOUNDS_NO_POE` определить `best-signature-time` — самое
раннее время в доказательствах существования базовой подписи. Если
`best-signature-time` раньше даты выпуска сертификата подписанта, то возвратить
`INDETERMINATE` со статусом `NOT_YET_VALID`. Если `best-signature-time` позже
даты выпуска сертификата подписанта, то возвратить `PASSED`.

**Шаг 3.** Если входной статус есть `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то
проанализировать криптографические ограничения, приведшие к вынесению вердикта.
Если имеется доказательство того, что алгоритмы, покрытые ограничениями,
применялись до ввода ограничений, то возвратить `PASSED`.

**Шаг 4.** Возвратить вердикт и статус, полученные на шаге 1.

### 8.2.3 <a name="Processes23"></a>Проверка подписи профиля B-B

При проверке подписи профиля B-B входными данными являются:

- РЭЦП профиля B-B;
- подписанный документ или его хэш-значение (опционально);
- список политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально). 

Проверка подписи состоит из следующих шагов.

**Шаг 1 (проверка формата).** 
Проверить, что РЭЦП соответствует допустимому формату (CAdES, XAdES или PAdES).
Если формат нарушен, то возвратить `FAILED` со статусом `FORMAT_FAILURE`.

**Шаг 2 (идентификация COK подписанта).** 
Найти СОК подписанта, используя ссылки в атрибутах РЭЦП (например, в атрибуте
`SigningCertificate`). Если подходящий сертификат не найден, то возвратить
`INDETERMINATE` со статусом `NO_SIGNING_CERTIFICATE_FOUND`.

<!--
todo: Первую ссылку? В документе etsi идет речь о первой подходящей ссылке.
-->

Искомый сертификат может содержаться в РЭЦП (например, в атрибуте
`CertificateValues`), передаваться как входной параметр прикладной программой
или размещаться по доступному ППП адресу. Хэш-значение проверяемого сертификата
ДОЛЖНО сравниваться с хэш-значением, указанным в ссылке. Если в ссылке указаны
имя эмитента и серийный номер сертификата, то эти данные также ДОЛЖНЫ
проверяться.

**Шаг 3 (инициализация контекста).** 
Определить следующие данные, необходимые для проверки подписи:

- политику применения сертификатов;
- аттестаты;
- криптографические ограничения.

Если нужные данные не найдены или при их определении произошла ошибка,
то возвратить `INDETERMINATE` со статусами `SIGNATURE_POLICY_NOT_AVAILABLE`
и `POLICY_PROCESSING_ERROR` соответственно.

При поиске нужных данных сначала определяется политика проверки подписи.
Политика задается идентификатором, который содержится в атрибуте
`SignaturePolicyIdentifier` РЭЦП. Затем по идентификатору политики определяется
документ, который описывает политику и, в том числе, искомые выходные данные.
Искомый документ может быть размещен в атрибуте `SignaturePolicyStore` РЭЦП.

Если в атрибуте `SignaturePolicyIdentifier` указано хэш-значение документа с
описанием политики, то это хэш-значение ДОЛЖНО сравниваться с фактическим.

Если атрибут `SignaturePolicyIdentifier` не содержится в РЭЦП, то используется
политика по умолчанию. Если политики по умолчанию нет, то используется неявная
политика, которая, как правило, задает минимальные ограничения или определяется
предопределенными соглашениями.

Если прикладная программа задает список допустимых политик, то ДОЛЖНО быть
проверено, что выбранная политика содержится в этом списке. В противном случае,
в зависимости от настроек ППП, проверка либо прекращается с возвратом
`INDETERMINATE`, либо продолжается с выбранной политикой.

**Шаг 4 (проверка СОК подписанта).**
Выполнить алгоритм проверки сертификата, определенный в
[8.2.2.2](#Processes222). Передать алгоритму входные данные и данные, полученные
на шаге 3. Если время проверки не задано, то передать текущее время.

Если алгоритм возвращает статус, отличный от `OK`, `TRY_LATER`,
`REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE` и
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то завершить проверку подписи с вердиктом
`INDETERMINATE` и полученным статусом. В противном случае зафиксировать
возвращенные алгоритмом цепочку сертификатов и статус.

**Шаг 5 (проверка базовой подписи).**
Проверить базовую ЭЦП на открытом ключе из сертификата подписанта:

а) использовать хэш-значение подписанного документа, либо вычислить хэш-значение
самостоятельно. Если ни хэш-значение, ни документ не переданы на вход, то
возвратить `INDETERMINATE` и статус `SIGNED_DATA_NOT_FOUND`;

б) сравнить полученное хэш-значение с хэш-значением, указанным в атрибуте
`MessageDigest` РЭЦП. Если хэш-значения отличаются, то возвратить `FAILED` и
статус `HASH_FAILURE`;

в) извлечь из СОК подписанта открытый ключ и долговременные параметры,
скомпоновать и хэшировать подписанные атрибуты, извлечь из РЭЦП базовую подпись,
передать полученные данные в алгоритм проверки подписи. При отрицательном
результате проверки возвратить `FAILED` и статус `SIG_CRYPTO_FAILURE`. Если
долговременные параметры представлены в сертификате через ссылку на параметры
УЦ, то параметры ДОЛЖНЫ быть восстановлены по цепочке, построенной на шаге 4.

**Шаг 6 (обработка статуса цепочки сертификатов).**
Обработать статус цепочки сертификатов, построенной на шаге 4, следующим
образом:

а) цепочка имеет статус `REVOKED_NO_POE`, если представлен аттестат отзыва
некоторого ее сертификата. При обработке данного статуса проверить наличие в
РЭЦП штампов времени в виде подписанных атрибутов (например,
`ContentTimeStamp`). Если имеется корректный штамп, выпущенный позже аттестата
отзыва (другими словами, подпись выработана после отзыва сертификата), то
закончить проверку с возвратом `FAILED` и статусом `REVOKED`. Если подходящий
штамп не обнаружен, то возвратить `INDETERMINATE` и статус `REVOKED_NO_POE`. Для
проверки штампа использовать алгоритм [8.2.2.3](#Processes223);

б) цепочка имеет статус `OUT_OF_BOUNDS_NO_POE`, если в заданный момент проверки
один из ее сертификатов не был действительным. При обработке данного статуса
проверить наличие в РЭЦП штампов времени в виде подписанных атрибутов. Если
имеется действительный штамп, выпущенный позже окончания действия сертификата,
то возвратить `INDETERMINATE` и статус `EXPIRED`. В противном случае возвратить
`INDETERMINATE` и статус `OUT_OF_BOUNDS_NO_POE`. Для проверки штампа
использовать алгоритм [8.2.2.3](#Processes223);

в) во всех остальных случаях когда статус цепочки отличен от `OK`,
возвратить `INDETERMINATE` и этот статус.

**Шаг 7 (проверка дополнительных ограничений).**
Проверить, что РЭЦП удовлетворяет ограничениям на атрибуты и криптографическим
ограничениям:

а) проверить каждый атрибут, который должен присутствовать в РЭЦП в соответствии
с ограничениями, построенными на шаге 3. Если атрибут присутствует, но имеет
неверный формат, то он считается отсутствующим. Для атрибута проверяются
ограничения, заданные в его описании (см. [6](06Attrs.md)). При нарушении
ограничений возвратить `INDETERMINATE` и статус `SIG_CONSTRAINTS_FAILURE`;

б) проверить, что все криптографические алгоритмы, использованные в РЭЦП и в
цепочке сертификатов, построенной на шаге 4, сохраняют стойкость в момент
проверки. Учитывать не только перечень алгоритмов, но и их настройки:
долговременные параметры, длины ключей.

Если криптографические ограничения не выполнены, то проверить наличие в РЭЦП
штампов времени в виде подписанных атрибутов. Если имеется действительный штамп,
выпущенный в момент, когда криптографические ограничения уже были введены, то
закончить проверку с возвратом `INDETERMINATE` и статусом
`CRYPTO_CONSTRAINTS_FAILURE`. Если подходящий штамп не обнаружен, то возвратить
`INDETERMINATE` и статус `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`. Для проверки
штампа использовать алгоритм [8.2.2.3](#Processes223).

**Шаг 8.** Возвратить `PASSED` вместе с цепочкой сертификатов, полученной на
шаге 4.

<!-- нужна ли выходная цепочка? -->

### 8.2.4 <a name="Processes24"></a>Проверка подписи профилей B-T и B-LT

При проверке подписи профилей B-T и B-LT входными данными являются:

- РЭЦП профиля B-T или B-LT;
- подписанный документ или его хэш-значение (опционально);
- список допустимых политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально);
- предполагаемое время выработки подписи (опционально).

Предполагаемое время выработки подписи определяется прикладной программой.
Это момент времени, к которому подпись предположительно уже была
выработана. Прикладная программа МОЖЕТ определить предполагаемое время по
атрибуту `SigningTime`.

При успешной проверке вердикт `PASSED` сопровождается дополнительной
информацией — самым ранним моментом времени, к которому подпись была
выработана согласно штампам времени. Этот момент фиксируется в переменной
`best-signature-time`.

Проверка подписи состоит из следующих шагов.

**Шаг 1 (список штампов времени).** 
Составить список штампов времени, представленных в РЭЦП в виде
неподписанных атрибутов (например, `SignatureTimeStamp`).

Инициализировать переменную `best-signature-time` предполагаемым временем 
выработки подписи. 

**Шаг 2 (проверка подписи профиля B-B).** 
Проверить РЭЦП как подпись профиля B-B. Использовать алгоритм
[8.2.3](#Processes23). Переадресовать алгоритму собственные входные данные.
Перейти на следующий шаг, если алгоритм возвратил вердикт `PASSED` или вердикт
`INDETERMINATE` с одним из следующих статусов:
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, 
`TRY_LATER` или `OUT_OF_BOUNDS_NO_POE`. Иначе — завершить проверку, возвратив 
вердикт и статус алгоритма [8.2.3](#Processes23). 

**Шаг 3 (проверка штампов времени).**
Для каждого штампа времени из списка, составленного на шаге 1, выполнить
следующие действия:

а) проверить, что указанное в штампе хэш-значение соответствует хэш-значению
подписанных атрибутов РЭЦП. В случае несоответствия исключить штамп из списка и
перейти к следующему штампу;

б) проверить штамп с помощью алгоритма [8.2.2.3](#Processes223). Если алгоритм
возвращает `PASSED`, то зафиксировать отметку времени, указанную в штампе (время
выпуска). В противном случае, в зависимости от политики проверки подписи, либо
просто исключить штамп из списка и перейти к следующему штампу, либо завершить
проверку подписи. В случае завершения вердикт и статус определяются политикой;

в) если отметка времени в штампе меньше `best-signature-time`, то записать
отметку в `best-signature-time`.

**Шаг 4 (сравнение отметок времени).** 
Выполнить следующие действия:

а) если на шаге 2 получен вердикт `INDETERMINATE` со статусом `REVOKED_NO_POE`
или `REVOKED_CA_NO_POE`, то обработать аттестаты отзыва, которые привели к
вынесению вердикта. Если аттестаты выпущены позже `best-signature-time`, то
перейти к подшагу г). Иначе – закончить проверку с полученными на шаге 2
вердиктом и статусом;

б) если вердикт получен со статусом `OUT_OF_BOUNDS_NO_POE`, то обработать
сертификаты, которые привели к вынесению вердикта. Если сертификаты начали
действовать ранее `best-signature-time`, то закончить проверку с полученными на
шаге 2 вердиктом и статусом. Иначе — возвратить `FAILED` и статус
`NOT_YET_VALID`;

в) если вердикт получен со статусом `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то
обработать криптографические ограничения, которые привели к вынесению вердикта.
Если ограничения вступили в действие позже `best-signature-time`, то перейти к
подшагу г). Иначе — закончить проверку с полученными на шаге 2 вердиктом и
статусом;

г) проверить, что штампы списка, составленного на шаге 1 и уточненного на шаге
3, непротиворечивы. Во-первых, штампы ДОЛЖНЫ быть выпущены позже штампов в виде
подписанных атрибутов (например, `ContentTimeStamp`). Во-вторых, если иное не
оговорено политикой проверки, ДОЛЖНЫ выполняться ограничения СТБ 34.101.82
относительно полей `accuracy` и `ordering` компонентов `TSTInfo` штампов,
выпущенных одной или несколькими службами. В случае обнаружения противоречий
закончить проверку с вердиктом  `INDETERMINATE` и статусом
`TIMESTAMP_ORDER_FAILURE`.

<!--
todo: связать с СТБ 34.101.82

For each time-stamp token remaining in the set of signature time-stamp
tokens, the process shall check the coherence in the values of the times
indicated in the time-stamp tokens. They shall be posterior to the times
indicated in any time-stamp token computed on the signed data
(content-time-stamp). The process shall apply the rules specified in IETF
RFC 3161 [3], clause 2.4.2 regarding the order of time-stamp tokens
generated by the same or different TSAs given the accuracy and ordering
fields' values of the TSTInfo field, unless stated differently by the
signature validation constraints. If all the checks end successfully, the
process shall go to the next step. Otherwise the process shall return the
indication INDETERMINATE with the sub-indication TIMESTAMP_ORDER_FAILURE.
-->

**Шаг 5 (контроль задержек).**
Если список, составленный на шаге 1 и уточненный на шаге 3 непуст, и политика
ограничивает задержку штампов времени, то проверить выполнение следующих
условий:

а) в РЭЦП присутствует атрибут `SigningTime`;

б) время, указанное в атрибуте `SigningTime`, увеличенное на задержку, указанную
в политике, больше чем `best-signature-time`.

Если условия не выполнены, то закончить проверку с вердиктом `INDETERMINATE` и
статусом `SIG_CONSTRAINTS_FAILURE`.

<!--
todo: странно, что штампы времени могут отсутствовать

В оригинале:
if the signature contains a signature time-stamp token and the validation 
constrains specify a time-stamp delay ...
-->

**Шаг 6 (проверка обновления).**
Если на шаге 2 получен вердикт `INDETERMINATE` со статусом `TRY_LATER`, то
проверить актуальность аттестатов отзыва, приведших к вынесению вердикта. Для
этого выполнить алгоритм [8.2.2.1](#Processes221), использовав
`best-signature-time` в качестве времени проверки. Если алгоритм возвращает
`TRY_LATER`, то закончить проверку с вердиктом `INDETERMINATE` и статусом
`TRY_LATER`.

**Шаг 7 (проверка дополнительных ограничений).**
Повторить шаг 7 алгоритма [8.2.3](#Processes23) проверки подписи профиля B-B,
использовав `best-signature-time` в качестве времени проверки.

**Шаг 8.** Возвратить `PASSED` вместе с цепочкой сертификатов, полученной
на шаге 2, и `best-signature-time`.

<!-- нужна ли выходная цепочка? -->

### 8.2.5 <a name="Processes25"></a>Проверка подписи профиля B-LTA

При проверке подписи профиля B-LTA входными данными являются:

- РЭЦП профиля B-LTA;
- подписанный документ или его хэш-значение (опционально);
- список допустимых политик проверки подписи (опционально);
- СОК подписанта (опционально);
- время проверки (опционально);
- список точек доверия (опционально);
- другие аттестаты (опционально);
- список доказательств существования (опционально).

<!--
todo: Дополнительный вход - evidence records
Пока его игнорируем. Иначе нужно вводить rfc4998, rfc6283
-->

Проверка подписи состоит из следующих шагов.

**Шаг 1 (сбор доказательств существования).** 
Включить в список доказательств существования все объекты РЭЦП. 
Зафиксировать их существование на текущий момент времени.

**Шаг 2 (проверка подписи профиля B-T/B-LT).** 
Проверить РЭЦП как подпись профиля B-T/B-LT. Использовать алгоритм
[8.2.4](#Processes24), переадресовав ему собственные входные данные.

Обработать результат работы алгоритма следующим образом:

а) искать в РЭЦП архивные атрибуты, специфичные для профиля B-LTA
((например, атрибут `ArchiveTimeStamp` с архивным штампом времени).
Если РЭЦП не содержит архивных атрибутов, то возвратить вердикт и статус 
алгоритма [8.2.4](#Processes24); 

б) если алгоритм [8.2.4](#Processes24) возвратил `PASSED` и политика проверки 
подписи не требует проверки архивных атрибутов, то возвратить `PASSED`.
Если проверка архивных атрибутов все-таки нужна, то перейти на шаг 3;

в) Если алгоритм [8.2.4](#Processes24) возвратил `INDETERMINATE` с одним из
статусов `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE` или
`CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то перейти на шаг 3;

г) Возвратить вердикт и статус алгоритма [8.2.4](#Processes24).

**Шаг 3 (доказательство для подписи).**
Добавить подпись в список доказательств существования. Зафиксировать ее
существование в момент времени `best-signature-time`, который является
дополнительным выходом алгоритма [8.2.4](#Processes24), выполненного на шаге 2.

<!--
todo: разобраться, для базовой подписи или просто для подписи
-->

**Шаг 4 (обработка штампов времени).**
Обработать штампы времени, от выпущенных раньше к выпущенным позже. 
Для каждого штампа выполнить следующие действия:

а) проверить штамп с помощью алгоритма [8.2.2.3](#Processes223);

б) если алгоритм [8.2.2.3](#Processes223) возвращает `PASSED` и функция
хэширования, использованная в штампе, удовлетворяет криптографическим
ограничениям на момент выпуска штампа, то извлечь из штампа доказательства
существования. Использовать алгоритм [8.2.2.6](#Processes226). Передать на вход
алгоритма текущий список доказательств. Возвращенный алгоритмом список добавить
к текущему;

в) если алгоритм [8.2.2.3](#Processes223) возвращает вердикт `INDETERMINATE` с
одним из статусов `REVOKED_NO_POE`, `REVOKED_CA_NO_POE`, `OUT_OF_BOUNDS_NO_POE`
или `CRYPTO_CONSTRAINTS_FAILURE_NO_POE`, то выполнить алгоритм
[8.2.2.7](#Processes227) повторной проверки подписи. Подать на вход алгоритма
следующие данные:

- штамп времени, 
- вердикт и статус, полученные на подшаге а), 
- сертификат службы штампов времени,
- список точек доверия, 
- текущий список доказательств существования, 
- аттестаты, 
- политику применения сертификатов, 
- криптографические ограничения.

Если алгоритм [8.2.2.7](#Processes227) возвращает `PASSED` и функция
хэширования, использованная в штампе, удовлетворяет криптографическим
ограничениям на момент выпуска штампа, то извлечь из штампа доказательства
существования. Использовать алгоритм [8.2.2.6](#Processes226). Подать на вход
алгоритма текущий список доказательств. Возвращенный алгоритмом список добавить
к текущему;

г) в остальных случаях, если противное не оговорено политикой проверки подписи,
игнорировать штамп времени. Однако если политика требует проверки корректности
штампов времени, то возвратить вердикт и статус, определяемые политикой.

**Шаг 5 (повторная проверка подписи).**
Выполнить алгоритм [8.2.2.7](#Processes227) повторной проверки подписи со
следующими входными данными:

- РЭЦП;
- вердикт и статус, полученные на шаге 2;
- СОК подписанта;
- список точек доверия;
- текущий список доказательств существования;
- аттестаты;
- политика применения сертификатов;
- криптографические ограничения.

Если вердикт алгоритма отличается от `PASSED`, то возвратить этот вердикт и 
соответствующий статус.

**Шаг 6 (самое раннее доказательство существования).**
По текущему списку доказательств существования определить самый ранний 
момент времени, когда подпись существовала.

<!--
todo: опять, базовая подпись или просто подпись.
-->

**Шаг 7 (проверка дополнительных ограничений).**
Повторить шаг 7 алгоритма [8.2.3](#Processes23) проверки подписи профиля B-B,
использовав время, полученное на шаге 6, в качестве времени проверки.

**Шаг 8.** Возвратить `PASSED`.
